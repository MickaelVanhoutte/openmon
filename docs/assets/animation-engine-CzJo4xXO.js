import{g as p}from"./gsap-DDlvirwQ.js";import{G as g}from"./main-B0gIQfWp.js";const b={"player-0":{x:22,y:80,z:0,scale:1,opacity:1},"opponent-0":{x:75,y:37,z:200,scale:.85,opacity:1}},C={"player-0":{x:22,y:80,z:0,scale:.9,opacity:1},"player-1":{x:35,y:85,z:10,scale:.9,opacity:1},"opponent-0":{x:60,y:32,z:200,scale:.75,opacity:1},"opponent-1":{x:92,y:37,z:210,scale:.75,opacity:1}};class A{containerWidth=800;containerHeight=600;battleType="SINGLE";setContainerBounds(t,e){this.containerWidth=t,this.containerHeight=e}setLayout(t){this.battleType=t}getSlotPosition(t){const e=`${t.side}-${t.index}`,i=(this.battleType==="SINGLE"?b:C)[e];return i?{...i}:{x:50,y:50,z:100,scale:1,opacity:1}}toScreenCoords(t,e){const s=e*t.scale;return{left:t.x/100*this.containerWidth-s/2,top:t.y/100*this.containerHeight-s/2,width:s,height:s,opacity:t.opacity}}lerp(t,e,s){const i=Math.max(0,Math.min(1,s));return{x:t.x+(e.x-t.x)*i,y:t.y+(e.y-t.y)*i,z:t.z+(e.z-t.z)*i,scale:t.scale+(e.scale-t.scale)*i,opacity:t.opacity+(e.opacity-t.opacity)*i}}behind(t,e){return{...t,z:t.z+e}}above(t,e){return{...t,y:t.y-e}}getContainerBounds(){return{width:this.containerWidth,height:this.containerHeight}}}class k{pools=new Map;active=new Set;maxPoolSize;constructor(t=20){this.maxPoolSize=t}async preload(t){const e=t.map(s=>{const i=g[s];return i?new Promise(n=>{const o=new Image;o.onload=()=>n(),o.onerror=()=>n(),o.src=i.path}):Promise.resolve()});await Promise.all(e)}acquire(t){const e=g[t];if(!e)return null;const s=this.pools.get(t)||[];let i=s.pop();return i||(i=this.createElement(t,e)),this.active.add(i),this.pools.set(t,s),i}release(t){if(!this.active.has(t))return;this.active.delete(t);const e=t.dataset.effectName;if(!e)return;const s=this.pools.get(e)||[];s.length<this.maxPoolSize?(t.style.display="none",s.push(t),this.pools.set(e,s)):t.remove()}clear(){this.pools.forEach(t=>{t.forEach(e=>e.remove())}),this.pools.clear(),this.active.forEach(t=>t.remove()),this.active.clear()}getStats(){let t=0;return this.pools.forEach(e=>{t+=e.length}),{pooled:t,active:this.active.size}}createElement(t,e){const s=document.createElement("div");return s.dataset.effectName=t,s.style.cssText=`
			position: absolute;
			width: ${e.frameWidth}px;
			height: ${e.frameHeight}px;
			background-image: url(${e.path});
			background-repeat: no-repeat;
			pointer-events: none;
		`,s}}const z={ballistic:c=>1-Math.pow(2*c-1,2),ballisticUp:c=>-3*c*c+4*c,ballisticDown:c=>c*c,quadUp:c=>1-Math.pow(1-c,2),quadDown:c=>c*c,swing:c=>.5-Math.cos(c*Math.PI)/2};function L(){Object.entries(z).forEach(([c,t])=>{p.registerEase(c,t)})}const T={normal:"#A8A878",fire:"#F08030",water:"#6890F0",electric:"#F8D030",grass:"#78C850",ice:"#98D8D8",fighting:"#C03028",poison:"#A040A0",ground:"#E0C068",flying:"#A890F0",psychic:"#F85888",bug:"#A8B820",rock:"#B8A038",ghost:"#705898",dragon:"#7038F8",dark:"#705848",steel:"#B8B8D0",fairy:"#EE99AC"},v={normal:0,fire:0,water:200,electric:50,grass:90,ice:180,fighting:-20,poison:280,ground:30,flying:250,psychic:320,bug:70,rock:35,ghost:260,dragon:270,dark:0,steel:220,fairy:330},R={normal:"impact",fire:"fire",water:"water",electric:"thunder",grass:"leaf",ice:"ice",fighting:"impact",poison:"poison",ground:"rock",flying:"wind",psychic:"lightball",bug:"leaf",rock:"rock",ghost:"shadowball",dragon:"fire",dark:"shadowball",steel:"impact",fairy:"lightball"};class _{container;positionSystem;effectPool;moveRegistry=new Map;activeTimelines=new Set;initialized=!1;constructor(t){this.container=t,this.positionSystem=new A,this.effectPool=new k}initialize(){if(this.initialized)return;const t=this.container.getBoundingClientRect();this.positionSystem.setContainerBounds(t.width,t.height),L(),this.initialized=!0}setLayout(t){this.positionSystem.setLayout(t)}getEffectZIndex(t){return t.side==="player"?200:4}registerMove(t,e){this.moveRegistry.set(t.toLowerCase(),e)}async playMove(t){this.initialized||this.initialize();const e=this.moveRegistry.get(t.moveName.toLowerCase());e?await e(this,t):await this.playFallbackAnimation(t)}async playFallbackAnimation(t){const{attacker:e,defender:s,moveCategory:i,moveType:n}=t,o=Array.isArray(s)?s[0]:s,a=this.getTypeColor(n),l=this.getTypeHueAngle(n),r=R[n.toLowerCase()]??"impact";switch(i){case"physical":await this.dashAttack(e,o,a,l,r);break;case"special":await this.projectileAttack(e,o,a,l,r);break;case"status":await this.statusEffect(e,a,l);break}}async dashAttack(t,e,s,i,n){const o=t.element.getBoundingClientRect(),a=e.element.getBoundingClientRect(),l=a.left-o.left,r=a.top-o.top,h=Math.sqrt(l*l+r*r),f=Math.max(0,h-30),d=h>0?f/h:0,u=l*d,y=r*d,m=p.timeline();this.activeTimelines.add(m),m.to(t.element,{x:u,y,duration:.2,ease:"power2.in"}).add(()=>{this.showSpriteEffect(n,e,{hueRotate:i,scale:1,tint:s,zIndex:this.getEffectZIndex(t.slot)}),this.shake(e.element,8,150)}).to(t.element,{x:0,y:0,duration:.3,ease:"power2.out"}),await m.then(()=>{}),this.activeTimelines.delete(m),this.resetSpriteToHome(t)}async projectileAttack(t,e,s,i,n){await this.flashElement(e.element,s,150),await Promise.all([this.showSpriteEffect(n,e,{hueRotate:i,scale:1.2,tint:s,zIndex:100}),this.shake(e.element,6,150)])}async statusEffect(t,e,s){await this.flashElement(t.element,e,300),await this.showSpriteEffect("buff",t,{hueRotate:s,scale:.8,opacity:.7,tint:e,zIndex:100}),await this.shake(t.element,3,200)}async flashElement(t,e,s){const i=p.timeline();this.activeTimelines.add(i),i.to(t,{filter:`brightness(2) drop-shadow(0 0 10px ${e})`,duration:s/2e3}).to(t,{filter:"brightness(1) drop-shadow(0 0 0 transparent)",duration:s/2e3}),await i.then(()=>{}),this.activeTimelines.delete(i)}async showEffectAt(t,e,s={}){const i=this.effectPool.acquire(t);if(!i)return;const n=g[t];if(!n){this.effectPool.release(i);return}const o=this.positionSystem.toScreenCoords(e,n.frameWidth),a=s.duration||300,r=1e3/(n.fps||24);i.style.display="block",i.style.left=`${o.left}px`,i.style.top=`${o.top}px`,i.style.opacity=String(s.opacity??1),i.style.transform=`scale(${s.scale??1})`,this.container.appendChild(i),await this.animateSpriteSheet(i,n.frames,r,a),this.effectPool.release(i)}async moveEffect(t,e,s,i,n="linear"){const o=this.effectPool.acquire(t);if(!o)return;const a=g[t];if(!a){this.effectPool.release(o);return}const l=this.positionSystem.toScreenCoords(e,a.frameWidth),r=this.positionSystem.toScreenCoords(s,a.frameWidth);o.style.display="block",o.style.left=`${l.left}px`,o.style.top=`${l.top}px`,this.container.appendChild(o);const h=p.timeline();this.activeTimelines.add(h),h.to(o,{left:r.left,top:r.top,duration:i/1e3,ease:n}),await h.then(()=>{}),this.activeTimelines.delete(h),this.effectPool.release(o)}async shake(t,e,s){const i=p.timeline();this.activeTimelines.add(i);const n=Math.floor(s/50);for(let o=0;o<n;o++){const a=(Math.random()-.5)*e*2,l=(Math.random()-.5)*e*2;i.to(t,{x:a,y:l,duration:.05})}i.to(t,{x:0,y:0,duration:.05}),await i.then(()=>{}),this.activeTimelines.delete(i),p.set(t,{clearProps:"x,y"})}async backgroundFlash(t,e,s=.5){const i=document.createElement("div");i.style.cssText=`
			position: absolute;
			inset: 0;
			background-color: ${t};
			opacity: 0;
			pointer-events: none;
			z-index: 1000;
		`,this.container.appendChild(i);const n=p.timeline();this.activeTimelines.add(n),n.to(i,{opacity:s,duration:e/2e3}).to(i,{opacity:0,duration:e/2e3}),await n.then(()=>{}),this.activeTimelines.delete(n),i.remove()}async screenShake(t,e){await this.shake(this.container,t,e)}async wait(t){return new Promise(e=>setTimeout(e,t))}getPosition(t){return this.positionSystem.getSlotPosition(t)}behind(t,e){return this.positionSystem.behind(t,e)}above(t,e){return this.positionSystem.above(t,e)}async showSpriteEffect(t,e,s={}){const i=this.effectPool.acquire(t);if(!i)return;const n=g[t];if(!n){this.effectPool.release(i);return}const a=("element"in e?e.element:e).getBoundingClientRect(),l=this.container.getBoundingClientRect(),r=a.left-l.left+a.width/2,h=a.top-l.top+a.height/2,f=s.duration??400,d=s.scale??1,y=1e3/(n.fps??24);if(i.style.display="block",i.style.position="absolute",i.style.left=`${r-n.frameWidth*d/2}px`,i.style.top=`${h-n.frameHeight*d/2}px`,i.style.width=`${n.frameWidth}px`,i.style.height=`${n.frameHeight}px`,i.style.opacity=String(s.opacity??1),i.style.transform=`scale(${d})`,i.style.zIndex=String(s.zIndex??100),s.hueRotate!==void 0){const m=s.tint??"rgba(255, 255, 255, 0.8)";i.style.filter=`hue-rotate(${s.hueRotate}deg) drop-shadow(0 0 12px ${m}) drop-shadow(0 0 6px ${m}) brightness(1.2)`}else s.tint&&(i.style.filter=`drop-shadow(0 0 12px ${s.tint}) drop-shadow(0 0 6px ${s.tint}) brightness(1.2)`);this.container.appendChild(i),await this.animateSpriteSheet(i,n.frames,y,f),i.style.filter="",this.effectPool.release(i),s.onComplete?.()}async moveSpriteTo(t,e,s={}){const i=s.duration??.25,n=s.returnDuration??.3,o=s.easing??"power2.in",a=s.returnEasing??"power2.out",l=s.overshoot??30,r=t.element.getBoundingClientRect();let h,f;if("element"in e){const E=e.element.getBoundingClientRect();h=E.left,f=E.top}else h=e.x,f=e.y;const d=h-r.left,u=f-r.top,y=Math.sqrt(d*d+u*u),m=Math.max(0,y-l),S=y>0?m/y:0,x=d*S,P=u*S,w=p.timeline();this.activeTimelines.add(w),w.to(t.element,{x,y:P,duration:i,ease:o}).to(t.element,{x:0,y:0,duration:n,ease:a}),await w.then(()=>{}),this.activeTimelines.delete(w),this.resetSpriteToHome(t)}async showImpact(t,e={}){const s="element"in t?t.element:t,i=e.intensity??8,n=e.duration??200,o=e.color??"#ffffff";await Promise.all([this.showSpriteEffect("impact",t,{scale:1.2,duration:n,tint:o}),this.shake(s,i,n)])}async flashSprite(t,e,s=150){await this.flashElement(t.element,e,s)}async pulseScale(t,e,s=300){const i=p.timeline();this.activeTimelines.add(i);const n=t.homePosition?.scale??1;i.to(t.element,{scale:e,duration:s/2e3,ease:"power2.out"}).to(t.element,{scale:n,duration:s/2e3,ease:"power2.in"}),await i.then(()=>{}),this.activeTimelines.delete(i)}resetSpriteToHome(t){const e=t.homePosition?.scale??1;p.set(t.element,{x:0,y:0,scale:e})}getTypeColor(t){return T[t.toLowerCase()]??T.normal}getTypeHueAngle(t){return v[t.toLowerCase()]??v.normal}cancelAll(){this.activeTimelines.forEach(t=>t.kill()),this.activeTimelines.clear(),this.effectPool.clear()}async animateSpriteSheet(t,e,s,i){return new Promise(n=>{let o=0;const a=parseInt(t.style.width)||192,l=Date.now()+i,r=()=>{if(Date.now()>=l){n();return}t.style.backgroundPosition=`-${o*a}px 0`,o=(o+1)%e,setTimeout(r,s)};r()})}}export{_ as A,T,v as a};
